<!doctype html>
<html>
	<head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	</head>
	<body>
	</body>
	<script src="../nort/nort.js?202004171445"></script>
	<script>

const $trans = nort.translate

nort.translations.default = {
            general: {
                country_footer: `       [cases]: [country_footer.cf_cases]<br>
                                        [new_cases]: [country_footer.cf_new_cases]<br>
                                        [increase]: [country_footer.cf_increase]<br>
                                        [acceleration]: [country_footer.cf_acceleration]<br>
                                        [trend]: [country_footer.cf_trend]<br>
                                        `,
                header_text: " ",
                usa:   "USA",                 
            },
            country_footer: {
                cf_cases:           "Total reported cases",
                cf_new_cases:       "Daily new cases",
                cf_increase:        "New cases percentage",
                cf_acceleration:    "Increase variation. Indicates acceleration or slow-down from previous day.",
                cf_trend:           "Mid-term acceleration (filtered)",
            }
    }

nort.translations.fr = {
            general: {
                overall_comparison: "Comparaison globale",
                france:         "France",
                italy:          "Italie",
                spain:          "Espagne",
                germany:        "Allemagne",
                netherlands:    "Pays-bas", 
                united_kingdom: "Royaume-uni",
                usa:            "USA",  
                south_korea:    "Corée du sud",
                cases:          "Cas",
                new_cases:       "Nouv. cas",
                case_distribution: "Répartition des cas",
                cases_per_100k_persons: "Cas pour 100 000 habitants",
                daily_new_cases:    "Nouveaux cas par jour",
                actual_count:      "Valeur relevée",
                filtered:         "Lissage",
                increase:           "Augmentation",
                acceleration:       "Accélération",
                trend:              "Tendance",
                march:              "mars",
                april:              "avril",
                may:              "mai",
                covid_epidemic_as_of: "Epidémie de Covid-19 au",
                header_text: `<p>Source: <a href="ttps://www.eficiens.com/coronavirus-statistiques" targer="efficiens">https://www.eficiens.com/coronavirus-statistiques</a> 
                                pour les données brutes. </p> 
                                <p><b>Nouveauté:</b> les tableaux montrent les derniers chiffres en haut. </p> `
            },
            country_footer: {
                cf_cases:          "Nombre de cas total",
                cf_new_cases:       "Cas du jour",
                cf_increase:           "Nouveaux cas rapportés aux cas totaux.",
                cf_acceleration:       "Variation de l'augmentation. Indique l'accélération ou la décélération d'un jour à l'autre.",
                cf_trend:              "Tendance sur plusieurs jours. Un passage dans le vert indique le début de la fin de l'épidémie",
            }
    }

        var population = [67, 60, 47, 83, 17, 327, 67, 51 ]

        var rawdata = [
                ["[Date]",    "[france]",   "[italy]",   "[spain]",  "[germany]",  "[netherlands]", "[usa]", "[united_kingdom]",  "[south_korea]"],
                ["01 [march]", 130,        1694,       84,         117,            0,          42,             35,           4812],
                ["02 [march]", 191,        2036,       125,        151,            0,          57,             40,           5328],
                ["03 [march]", 212,        2502,       228,        188,            25,         85,             51,           5766],
                ["04 [march]", 285,        3089,       269,        240,            38,         111,            85,           6284],
                ["05 [march]", 423,        3858,       282,        349,            82,         175,           114,           6593],
                ["06 [march]", 613,        4636,       365,        534,            128,        252,           160,           7041],
                ["07 [march]", 949,        5883,       430,        684,            188,        352,           206,           7134],
                ["08 [march]", 1126,       7375,       674,        847,            264,        495,           271,           7382],
                ["09 [march]", 1412,       9172,       1231,       1112,           321,        643,           321,           7413],
                ["10 [march]", 1784,       10149,      1695,       1296,           382,        932,           373,           7755],
                ["11 [march]", 2281,       12464,      2182,       1567,           503,        1200,          456,           7869],
                ["12 [march]", 2876,       15113,      3059,       2369,           614,        1561,          596,           7979],
                ["13 [march]", 3661,       17660,      4334,       3062,           804,        2158,          798,           8086],
                ["14 [march]", 4499,       21157,      6252,       3795,           959,        2794,         1140,           8162],
                ["15 [march]", 5423,       24747,      7798,       4838,           1135,       3468,         1372,           8236],
                ["16 [march]", 6633,       27980,      9428,       6012,           1413,       4353,         1543,           8320],
                ["17 [march]", 7730,       31506,      11310,      7156,           1705,       5637,         1959,           8413],
                ["18 [march]", 9134,       35713,      13910,      8198,           2051,       8054,         2626,           8565],
                ["19 [march]", 10995,      41035,      17147,      10999,          2460,       11913,        3229,           8652],
                ["20 [march]", 12612,      47021,      20410,      13957,          2994,       17235,        3983,           8799],
                ["21 [march]", 14459,      53578,      25374,      16662,          3631,       23623,        5018,           8897],
                ["22 [march]", 16018,      59158,      28603,      18610,          4204,       32761,        5683,           8961],
                ["23 [march]", 19856,      63927,      33089,      22672,          4749,       42752,        6650,           9037],
                ["24 [march]", 22300,      69176,      39675,      27436,          5560,       51825,        8077,           9137],
                ["25 [march]", 25233,      74386,      47600,      31554,          6412,       64661,        9529,           9241],
                ["26 [march]", 29155,      80539,      56197,      36508,          7431,       81781,       11658,           9332],
                ["27 [march]", 32964,      86498,      64059,      42288,          8603,      101700,       14579,           9478],
                ["28 [march]", 37575,      92472,      72248,      48582,          9762,      121099,       17089,           9583],
                ["29 [march]", 40175,      97689,      78797,      52547,         10866,      141701,       19522,           9661],
                ["30 [march]", 44150,     101739,      85195,      57298,         11750,      162126,       22141,           9786],
                ["31 [march]", 52128,     105792,      94417,      61913,         12595,      185791,       25150,           9887],
                ["01 [april]", 56989,     110574,     102136,      67366,         13164,      212747,       29474,           9976],
                ["02 [april]", 59105,     115242,     112038,      73522,         14697,      241626,       33178,          10062],
                ["03 [april]", 64303,     119827,     117710,      79696,         15723,      273808,       38168,          10156],
                ["04 [april]", 68605,     124632,     124736,      85775,         16627,      307036,       41903,          10237],
                ["05 [april]", 70478,     128948,     130759,      91714,         17851,      333593,       47806,          10284],
                ["06 [april]", 74390,     132547,     135032,      95391,         18803,      362955,       51608,          10331],
                ["07 [april]", 78167,     135586,     140510,      99225,         19580,      393602,       55242,          10384],
                ["08 [april]", 82048,     139422,     146690,     103228,         20549,      425746,       60773,          10423],
                ["09 [april]", 86334,     143626,     152446,     108202,         21762,      459093,       65077,          10450 ],
                ["10 [april]", 90434,     147577,     157022,     113525,         23097,      493567,       70272,          10480 ],
                ["11 [april]", 93790,     152271,     161852,     117658,         24413,      525428,       78991,          10512 ],
                ["12 [april]", 95403,     156363,     166019,     120479,         25587,      553493,       84279,          10537 ],
                ["13 [april]", 98076,     159516,     169496,     123016,         26551,      578178,       88621,          10564 ],
                ["14 [april]",103573,     162488,     172541,     125098,         27419,      603505,       93873,          10591 ],
                ["15 [april]",106206,     165155,     177633,     127584,         28153,      633630,       98476,          10613 ],
                ["16 [april]",108847,     168941,     182816,     130450,         29214,      664880,      103093,          10635 ],
                ["17 [april]",109252,     172434,     188068,     133830,         30449,      696621,      108692,          10653 ],
                ["18 [april]",111821,     175925,     191726,     137439,         31589,      724895,      114217,          10661 ],
                ["19 [april]",112606,     178972,     195944,     139897,         32655,      759086,      120067,          10674 ],
                ["20 [april]",114657,     181228,     200210,     141672,         33405,      784326,      124743,          10683 ],
                ["21 [april]",117324,     183957,     204178,     143457,         34134,      825183,      129044,          10694 ],
                ["22 [april]",119151,     187327,     208389,     145694,         34842,      842629,      133495,          10702 ],
                ["23 [april]",120804,     189973,     213024,     148046,         35729,      869172,      138078,          10708 ],
                ["24 [april]",122527,     192994,     219764,     150383,         36535,      890524,      143464,          10718 ],
                ["25 [april]",124114,     195351,     223759,     152438,         37190,      939235,      148377,          10728 ],
                ["26 [april]",124575,     197675,     207634+19000,   154175,     37845,      965910,      152840,          10738 ],
                ["27 [april]",128339,     199414,     209465+19000,   155193,     38245,      988451,      157149,          10752 ],
                ["28 [april]",129859,     201505,     210773+19000,   156337,     38416,     1012585,      161145,          10761 ],
                ["29 [april]",128442+3024,  203591,   212219+19000,   157641,     38802,     1039909,      165221,          10765 ],
                ["30 [april]",129581+3024,  205463,   213435+19000,   159119,     39316,     1069826,      171253,          10774 ],
                ["01 [May]", 130185+3024,   207428,   215216+19000,   160758,     39791,     1103781,      177454,          10780 ],
                ["02 [May]", 130979+3024,   209328,   216582+19000,   161703,     40236,     1133069,      182260,          10793 ],                
                ["03 [May]", 131287+3024,   210717,   217466+19000,   162496,     40571,     1158041,      186599,          10801 ],                
                ["04 [May]", 131863+3024,   211938,   218011+19000,   163175,     40770,     1180634,      190584,          10804 ],
                ["05 [May]", 132967+3024,   213013,   219329+19000,   163860,     41087,     1204475,      194990,          10806 ],
                ["06 [May]", 137150-222,   214457,   220325+19000,   164807,     41319,      1228603,      206715,          10810 ],                
                ["07 [May]", 137779-222,   215858,   221447+19000,   166091,     41774,          -1,          -1,             -1 ],                
                //["06 [May]",      1,            -1,        -1,             -1,       -1,          -1,          -1,             -1 ],                
                ]

        var lastUpdate = rawdata[rawdata.length-1][0]+" 2020"
        
        function getCountryBarGraphData(col)  {
            var ret = {
			bars:[$trans('[cases]'),$trans('[new_cases]')],
            data:[]
            }
            for (let i=1; i< rawdata.length; i++) {
                if (rawdata[i][col] > 0 ) {
                    ret.data.push([$trans(rawdata[i][0]),rawdata[i][col]] )
                }
            }
            return ret
        }

        function getPieChartData() {
			let colors = ['x', '#ff0000', '#00ff00','#0000ff', '#C0C0ff', '#ffc000', '#ff00c0', '#E08000'],

            ret = []
            for (let c = 1 ; c <= population.length; c++) {
                let x = 0
                for (let r = 1; r < rawdata.length; r++) {
                    if (rawdata[r][c] != -1 ) x =rawdata[r][c]
                }
                ret.push([ $trans(rawdata[0][c]), x, colors[c], ""])
            }
            return ret
        }

        function getIncidenceData() {
            let ret = {
			    bars:['Incidence'],
                data:[]}

            let pcd = getPieChartData()

            for (let i=0; i<pcd.length; i++ ) {
                ret.data.push([$trans(rawdata[0][i+1]), pcd[i][1]/population[i]/10])
            }
            return ret
        }

        function calcNC(tab) {
            let filtTrend = 0

            for (let l =1; l<tab.length; l++) {
                let nc = tab[l][1] - tab[l-1][1]
                let pnc = l>1 ? tab[l-1][1] - tab[l-2][1] : 0
                let incpc = "" 
                if (pnc>0) incpc = (nc / tab[l-1][1]*100 ).toFixed(1) + "%"
                let trend = (nc - pnc) / tab[l-1][1]
                let trendpc = ""
                if (! isNaN (trend) && isFinite(trend) )  { 
                    trendpc = (trend *100).toFixed(1) + "%"
                    filtTrend = filtTrend * 0.7 + trend *0.3
                }   

                tab[l].push( nc )
                tab[l].push( incpc ) 
                tab[l].push( trendpc ) 
                tab[l].push( (filtTrend *100).toFixed(1) + "%" ) 
            }
        }
		
		function replaceElement(id, newElt) {
			var elt=document.getElementById(id);
			var parent=elt.parentNode;
			parent.replaceChild(newElt,elt);
			newElt.id=id;
			newElt.setAttribute ('style',elt.getAttribute('style'));
        }

        function styleCell(data, l,c) {
            let style = ""
            if (c == 4 || c ==5) {
                if ( data[l][c].startsWith("-")) style ="color: #006000;"
                else style ="color: #800000;"
            }
            return style            
        }
        
        function simpleTable( headings, data, stylefunc, reverse ){
            let headers = []
            let rows = []
            for (let i = 0 ; i< headings.length; i++) {
                headers.push ($th({style: "text-align: center"}, $trans(headings[i])))
            }

            function eachRow(l) {
                let cells = []
                for (c = 0; c< data[l].length; c++) {
                    cells.push($td({style: "text-align: right; width: 7em;" + stylefunc(data,l,c)},data[l][c]))
                }
                rows.push ($tr({},cells))
            }

            if (reverse) for (let l = data.length-1  ; l>=0 ; l--)  eachRow(l);
            else for (let l = 0 ; l< data.length; l++)  eachRow(l);
            

            let e = $table({},
                $tr({}, headers), 
                rows
            )
            return e
        }

        function countrySection(Country, countryData, flags) {
            calcNC(countryData.data)

            flags = flags  || {}
            let hideTable = flags.hideTable || false
            let graphTitle = $trans( flags.graphTitle || '[daily_new_cases]' )

            let newCaseData = {
                bars: [$trans("[actual_count]"), $trans("[filtered]")],
                data: []
            }

            let v =0
            let preve = 0
            let p0 = 0
            let p1 = 0 
            let p2 = 0 
            let p3 = 0 
            let px1 = 0
            let px2 = 0
            let px3 = 0
            let fil = 0

            let l = countryData.data.length
            
            countryData.data.push(["X1",countryData.data[l-1][1],  (countryData.data[l-1][2]*.5 + countryData.data[l-2][2]*.5)  ])
            countryData.data.push(["X2",countryData.data[l-1][1],  (countryData.data[l-1][2]*.7 + countryData.data[l-2][2]*.3)   ])
            countryData.data.push(["X3",countryData.data[l-1][1],  (countryData.data[l-1][2]*.9 + countryData.data[l-2][2] *.1)   ])

            for (let i=1; i < countryData.data.length -3; i++) {


                p0 = countryData.data[i][2] 
                if (isNaN (p0) || !isFinite(p0) ) p0=0
                if (isNaN (px1) || !isFinite(px1) ) px1=0
                if (isNaN (px2) || !isFinite(px2) ) px2=0
                if (isNaN (px3) || !isFinite(px3) ) px3=0

                fil = fil *.2 + p0 * .8
                fil = p0


                if (i < countryData.data.length-1 ) px1 = countryData.data[i+1][2]; else px1 = fil
                if (i < countryData.data.length-2 ) px2 = countryData.data[i+2][2]; else px2 = fil
                if (i < countryData.data.length-3 ) px3 = countryData.data[i+3][2]; else px3 = fil


                v = ( p0 *24 + p1 *39 +p2 *24 + p3 *13 + p0 *24 + px1 *39 +px2 *24 + px3 *13) /200



                p3 = p2
                p2 = p1
                p1 = p0 
                p0 = px1
                px1 = px2
                px2 = px3
                
                newCaseData.data.push([$trans(countryData.data[i][0]) , countryData.data[i][2], v])
            }

            countryData.data.pop()
            countryData.data.pop()
            countryData.data.pop()            

            return [
                    $h2({style: "text-align: center"},Country),
                    $div({}, [
                    /*nort.elements.graph.barGraph({ 'title': 'Evolution','height': 450, 'width': 700 ,'withLinks': true, colors: ['blue','orange','#00ff00'], 
                        'onclick': function(b,r){ showBar(countryData, b,r) } }, countryData ),*/
                    nort.elements.graph.barGraph({ 'title': graphTitle,'height': 450, 'width': 700 ,'withLinks': true, colors: ['#e0e0ff','blue','#00ff00'], 
                        'onclick': function(b,r){ showBar(newCaseData, b,r) } }, newCaseData ),                        
                        ! hideTable ?
                            $div({style: "font-size: 80%; display: inline-block; margin-left: 20px;vertical-align: top"},
                                $div({},
                                    simpleTable(['[date]','[cases]','[new_cases]', "[increase]", "[acceleration]", "[trend]"], countryData.data, styleCell, true)),
                                    $br(),
                                    $htmldiv({style: "font-size: 100%; display: inline-block; margin-left: 20px;vertical-align: top"}, $trans("[country_footer]"))
                                ): ""
                        ]) 
                    ]
            //    ])
        }

		class GraphApp extends nort.components.containers.Form {
			constructor(properties) {
				super(properties)
            }

          	render() {

                let tab = nort.elements.tabber({},[
                    {label: $trans("[overall_comparison]"), page: 
                        $div({},nort.elements.graph.pieChart({ 'title':$trans('[case distribution]'),'size': 400,'withLinks': true  }, getPieChartData() ),
                                nort.elements.graph.barGraph({ 'title': $trans('[cases_per_100k_persons]'),'height': 450, 'width': 700 , colors: ['blue','orange','#00ff00'], 
                                'onclick': function(b,r){ } }, getIncidenceData() ) ,
                                $div({style: "font-size: 80%; display: inline-block; margin-left: 20px;vertical-align: top"},simpleTable(rawdata[0], rawdata.slice(1), function(r,c){}, true))
                            )}
                ])
                for (let i = 1; i < rawdata[0].length; i++) {
                    let gd = getCountryBarGraphData(i)
                    //if (i < rawdata[0].length -1 ) 
                        tab.addPage({ label:$trans(rawdata[0][i]), page: countrySection($trans(rawdata[0][i]),gd) } )
                    //else tab.addPage({ label:rawdata[0][i], page: countrySection(rawdata[0][i],gd, {graphTitle: "Réponse impulsionnelle", hideTable: true}) } )
                }
                tab.setPage(0)

                let ret = $div({style:"width: 100%; height: 100%; padding: 15px;"},
                        $div({ style: "display: flex; height: 100%; flex-flow: column"} , 
                        $h1({style: "text-align: center"},$trans("[covid_epidemic_as_of] "+ lastUpdate)),
                        $htmldiv({}, $trans("[header_text]")),
                        $div({style: "flex-grow: 1; display: flex"}, 
                            $div({style: "flex-grow: 1"},tab)
                             )
                        ))

                return ret
            }
            
        }
        
        function showBar(data, b,r) {
            let bi, ri 
            for (let i = 0; i<data.data.length; i++) {
                if (b == data.data[i][0]) bi = i
            }
            for (let i = 0; i<data.bars.length; i++) {
                if (r ==data.bars[i]) ri = i
            }
            alert(data.data[bi][ri+1])
        }

        function addPulseResponse() {
            const TitreOnglet = "Filtrage convolutif"
            //population.push(TitreOnglet)
            rawdata[0].push(TitreOnglet)
            for (let i=1; i < rawdata.length; i++ ) {
                if (i <rawdata.length /3 ) rawdata[i].push(1)
                else if ( i == rawdata.length -1 ) rawdata[i].push(2001)
                else rawdata[i].push(1001)
            }
        }

        //addPulseResponse()

		nort.main = function() {
            nort.render(new GraphApp({ }))
		}
	</script>
</html>
